<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üêç Snake Game</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --size: 360px; --box: 20px; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; background: #222; color: #fff; font-family: system-ui, -apple-system, Arial, sans-serif;
      display: flex; flex-direction: column; align-items: center; min-height: 100vh; user-select: none;
    }
    h1 { margin: 16px 0 8px; font-size: 20px; }
    #score { margin: 6px 0 12px; font-size: 18px; }
    .wrap {
      width: min(92vw, var(--size));
      display: flex; flex-direction: column; align-items: center;
    }
    canvas {
      width: 100%; height: auto; background: #111; border: 2px solid #0f0; touch-action: none;
    }
    .pad {
      position: fixed; left: 0; right: 0; bottom: 16px;
      display: grid; grid-template-columns: 64px 64px 64px; grid-template-rows: 64px 64px 64px;
      gap: 8px; place-items: center; justify-content: center; pointer-events: none;
    }
    .pad button {
      pointer-events: auto; width: 64px; height: 64px; border-radius: 12px; border: 1px solid #555;
      background: #2b2b2b; color: #fff; font-size: 22px;
    }
    .pad .empty { opacity: 0; }
    .hint { opacity: .7; font-size: 13px; margin: 10px 0 70px; }
  </style>
</head>
<body>
  <h1>üêç Snake</h1>
  <div id="score">Score: 0</div>

  <div class="wrap">
    <canvas id="game" width="360" height="360"></canvas>
    <div class="hint">Tip: Swipe on the board or use the arrow buttons.</div>
  </div>

  <div class="pad">
    <span class="empty"></span>
    <button id="up">‚ñ≤</button>
    <span class="empty"></span>
    <button id="left">‚óÄ</button>
    <span class="empty"></span>
    <button id="right">‚ñ∂</button>
    <span class="empty"></span>
    <button id="down">‚ñº</button>
    <span class="empty"></span>
  </div>

  <script>
    const tg = window.Telegram?.WebApp || {};
    if (tg.expand) tg.expand();

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const BOX = 20;
    const CELLS = 18;
    const SIZE = BOX * CELLS;

    let snake = [{ x: 9 * BOX, y: 9 * BOX }];
    let dir = "RIGHT";
    let food = randomFood();
    let score = 0;
    let gameOver = false;

    // Keyboard (for desktop)  
    document.addEventListener("keydown", (e) => {
      const k = e.key;
      if (k === "ArrowLeft" && dir !== "RIGHT") dir = "LEFT";
      else if (k === "ArrowUp" && dir !== "DOWN") dir = "UP";
      else if (k === "ArrowRight" && dir !== "LEFT") dir = "RIGHT";
      else if (k === "ArrowDown" && dir !== "UP") dir = "DOWN";
    });

    // Swipe gestures (for mobile)
    let startX = 0, startY = 0;
    canvas.addEventListener("touchstart", (e) => {
      const t = e.changedTouches[0];
      startX = t.clientX; startY = t.clientY;
    }, { passive: true });

    canvas.addEventListener("touchend", (e) => {
      const t = e.changedTouches[0];
      const dx = t.clientX - startX;
      const dy = t.clientY - startY;
      if (Math.abs(dx) < 20 && Math.abs(dy) < 20) return;
      if (Math.abs(dx) > Math.abs(dy)) {
        if (dx > 0 && dir !== "LEFT") dir = "RIGHT";
        else if (dx < 0 && dir !== "RIGHT") dir = "LEFT";
      } else {
        if (dy > 0 && dir !== "UP") dir = "DOWN";
        else if (dy < 0 && dir !== "DOWN") dir = "UP";
      }
    }, { passive: true });

    // On-screen buttons  
    [["up","UP"],["down","DOWN"],["left","LEFT"],["right","RIGHT"]].forEach(([id, d]) => {
      document.getElementById(id).addEventListener("touchstart", () => setDir(d));
      document.getElementById(id).addEventListener("click", () => setDir(d));
    });

    function setDir(d) {
      if (d === "LEFT" && dir !== "RIGHT") dir = "LEFT";
      if (d === "RIGHT" && dir !== "LEFT") dir = "RIGHT";
      if (d === "UP" && dir !== "DOWN") dir = "UP";
      if (d === "DOWN" && dir !== "UP") dir = "DOWN";
    }

    function randomFood() {
      return { x: Math.floor(Math.random() * CELLS) * BOX, y: Math.floor(Math.random() * CELLS) * BOX };
    }

    function collision(head, arr) {
      return arr.some(s => s.x === head.x && s.y === head.y);
    }

    function gameLoop() {
      if (gameOver) return;

      ctx.fillStyle = "#111";
      ctx.fillRect(0, 0, SIZE, SIZE);

      ctx.fillStyle = "red";
      ctx.fillRect(food.x, food.y, BOX, BOX);

      for (let i = 0; i < snake.length; i++) {
        ctx.fillStyle = i === 0 ? "lime" : "green";
        ctx.fillRect(snake[i].x, snake[i].y, BOX, BOX);
      }

      let nx = snake[0].x;
      let ny = snake[0].y;
      if (dir === "LEFT") nx -= BOX;
      if (dir === "RIGHT") nx += BOX;
      if (dir === "UP") ny -= BOX;
      if (dir === "DOWN") ny += BOX;

      if (nx === food.x && ny === food.y) {
        score++;
        document.getElementById("score").textContent = "Score: " + score;
        food = randomFood();
      } else {
        snake.pop();
      }

      const newHead = { x: nx, y: ny };
      if (nx < 0 || ny < 0 || nx >= SIZE || ny >= SIZE || collision(newHead, snake)) {
        gameOver = true;
        document.getElementById("score").textContent = `üíÄ Game Over! Score: ${score}`;
        if (tg.sendData) tg.sendData(JSON.stringify({ score }));
        return;
      }

      snake.unshift(newHead);
    }

    setInterval(gameLoop, 100);
  </script>
</body>
</html>
